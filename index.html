<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Event Configurator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f7fa;
            margin: 0;
            padding: 20px;
        }
        h1 { text-align: center; }
        form {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 600px;
            margin: auto;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        label { display: block; margin-top: 10px; }
        input, select {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
        }
        .checkbox-group label {
            display: inline-block;
            margin-right: 10px;
        }
        button {
            margin-top: 15px;
            padding: 10px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover { background: #0056b3; }
        pre {
            background: #222;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            white-space: pre-wrap;
        }

        .events-list {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 600px;
            margin: 20px auto;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .event-item {
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            position: relative;
        }

        .event-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 10px;
        }

        .event-actions button {
            margin-left: 10px;
            padding: 5px 10px;
            font-size: 12px;
        }

        .edit-btn { background: #ffc107; }
        .delete-btn { background: #dc3545; }

        .file-actions {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        .file-actions button {
            margin: 0 10px;
        }

        #saveButton {
            background: #28a745;
        }

        .edit-mode {
            background-color: #f8f9fa;
            border: 2px solid #007bff;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
<h1>Event JSON Builder</h1>

<div class="file-actions">
    <button id="importButton">Importer action.json</button>
    <input type="file" id="fileInput" accept=".json" style="display:none">
    <button id="saveButton">Télécharger action.json</button>
</div>

<form id="eventForm">
    <label>Action:</label>
    <select id="action" required>
        <option value="">-- Choose Action --</option>
        <option value="click">Click</option>
        <option value="double_click">Double Click</option>
    </select>

    <label>Humidity (%):</label>
    <input type="number" id="humidity" min="0" max="100" placeholder="e.g. 70">

    <label>Temperature (°C):</label>
    <input type="number" id="temperature" placeholder="e.g. 35">

    <label>Luminosity (lx):</label>
    <input type="number" id="luminosity" placeholder="e.g. 200">

    <label>Date:</label>
    <input type="date" id="date">

    <label>Hour:</label>
    <input type="time" id="hour">

    <label>Repeat:</label>
    <select id="repeat">
        <option value="">-- Choose Repeat Option --</option>
        <option value="always">Always</option>
        <option value="never">Never</option>
        <option value="days">Custom Days</option>
    </select>

    <div id="daysGroup" class="checkbox-group" style="display:none;">
        <label><input type="checkbox" value="Mo">Mo</label>
        <label><input type="checkbox" value="Tu">Tu</label>
        <label><input type="checkbox" value="We">We</label>
        <label><input type="checkbox" value="Th">Th</label>
        <label><input type="checkbox" value="Fr">Fr</label>
        <label><input type="checkbox" value="Sa">Sa</label>
        <label><input type="checkbox" value="Su">Su</label>
    </div>

    <div style="margin-top: 15px;">
        <button type="submit" id="addEventButton">Ajouter un événement</button>
        <button type="button" id="updateEventButton" style="background-color: #28a745; display: none;">Mettre à jour</button>
        <button type="button" id="cancelEditButton" style="background-color: #6c757d; display: none;">Annuler</button>
        <button type="reset" id="resetButton" style="background-color: #dc3545;">Réinitialiser</button>
    </div>
</form>

<div id="eventsList" class="events-list">
    <h2>Événements enregistrés</h2>
    <div id="eventsContainer"></div>
</div>

<script>
    monStockage = localStorage;
    console.log(monStockage.getItem("event"));

    const form = document.getElementById('eventForm');
    const eventsContainer = document.getElementById('eventsContainer');
    const addEventButton = document.getElementById('addEventButton');
    const updateEventButton = document.getElementById('updateEventButton');
    const cancelEditButton = document.getElementById('cancelEditButton');
    const importButton = document.getElementById('importButton');
    const fileInput = document.getElementById('fileInput');
    const saveButton = document.getElementById('saveButton');
    const repeatSelect = document.getElementById('repeat');
    const daysGroup = document.getElementById('daysGroup');
    const dateInput = document.getElementById('date');
    const hourInput = document.getElementById('hour');
    const humidityInput = document.getElementById('humidity');
    const tempInput = document.getElementById('temperature');
    const lumiInput = document.getElementById('luminosity');
    const resetButton = document.getElementById('resetButton');

    let events = [];
    let editingIndex = -1;

    // Remplacer le bouton de chargement par un système d'importation de fichier
    importButton.addEventListener('click', () => {
        fileInput.click();
    });

    // Gérer l'importation du fichier sélectionné
    fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                events = data.events || [];
                renderEvents();
                localStorage.setItem('eventsData', JSON.stringify({ events }));
                alert('Événements importés avec succès !');
            } catch (error) {
                console.error('Erreur lors de la lecture du fichier:', error);
                alert('Erreur lors de la lecture du fichier. Vérifiez que le format est correct.');
            }
        };
        reader.onerror = (e) => {
            console.error('Erreur de lecture du fichier:', e);
            alert('Erreur lors de la lecture du fichier.');
        };
        reader.readAsText(file);
    });

    // Initialiser avec un tableau vide si le chargement échoue
    function initEmptyEvents() {
        events = [];
        renderEvents();
        alert('Impossible de charger les événements. Veuillez importer le fichier action.json manuellement ou commencer avec un nouveau fichier.');
    }

    // Amélioration de la fonction de sauvegarde
    saveButton.addEventListener('click', () => {
        const jsonData = JSON.stringify({ events }, null, 2);

        // Sauvegarder dans le stockage local
        localStorage.setItem('eventsData', jsonData);

        // Télécharger le fichier
        const blob = new Blob([jsonData], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = 'action.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        alert('Événements sauvegardés avec succès ! Le fichier action.json a été téléchargé.');
    });

    // Afficher les événements dans la liste
    function renderEvents() {
        eventsContainer.innerHTML = '';
        if (events.length === 0) {
            eventsContainer.innerHTML = '<p>Aucun événement enregistré.</p>';
            return;
        }

        events.forEach((event, index) => {
            const eventDiv = document.createElement('div');
            eventDiv.classList.add('event-item');
            if (index === editingIndex) {
                eventDiv.classList.add('edit-mode');
            }

            // Formater l'affichage de l'événement
            let conditions = [];
            if (event.condition.humidity !== undefined) conditions.push(`Humidité: ${event.condition.humidity}%`);
            if (event.condition.temperature !== undefined) conditions.push(`Température: ${event.condition.temperature}°C`);
            if (event.condition.luminosity !== undefined) conditions.push(`Luminosité: ${event.condition.luminosity}lx`);
            if (event.condition.date) conditions.push(`Date: ${event.condition.date}`);
            if (event.condition.hour) conditions.push(`Heure: ${event.condition.hour}`);

            eventDiv.innerHTML = `
                <strong>Action: ${event.action}</strong><br>
                ${conditions.join(', ')}<br>
                Répétition: ${event.repeat}
                <div class="event-actions">
                    <button class="edit-btn" data-index="${index}">Modifier</button>
                    <button class="delete-btn" data-index="${index}">Supprimer</button>
                </div>
            `;
            eventsContainer.appendChild(eventDiv);
        });

        // Ajouter les écouteurs d'événements aux boutons
        document.querySelectorAll('.edit-btn').forEach(button => {
            button.addEventListener('click', handleEditClick);
        });

        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', handleDeleteClick);
        });
    }

    function handleEditClick(e) {
        const index = parseInt(e.target.getAttribute('data-index'));
        editingIndex = index;
        const event = events[index];

        // Remplir le formulaire avec les données de l'événement
        document.getElementById('action').value = event.action;
        humidityInput.value = event.condition.humidity || '';
        tempInput.value = event.condition.temperature || '';
        lumiInput.value = event.condition.luminosity || '';

        // Gérer la date (format YYYY-MM-DD pour l'input date)
        if (event.condition.date) {
            const parts = event.condition.date.split('/');
            if (parts.length === 3) {
                // Convertir de DD/MM/YYYY à YYYY-MM-DD
                dateInput.value = `${parts[2]}-${parts[1]}-${parts[0]}`;
            }
        } else {
            dateInput.value = '';
        }

        hourInput.value = event.condition.hour || '';

        // Gérer la répétition
        if (event.repeat.length > 0 && "MoTuWeThFrSaSu".includes(event.repeat)) {
            repeatSelect.value = 'days';
            daysGroup.style.display = 'block';

            // Cocher les cases correspondantes
            daysGroup.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.checked = event.repeat.includes(cb.value);
            });
        } else {
            repeatSelect.value = event.repeat || 'never';
            daysGroup.style.display = repeatSelect.value === 'days' ? 'block' : 'none';
        }

        // Gérer la désactivation du sélecteur de répétition si une date est définie
        if (dateInput.value) {
            repeatSelect.disabled = true;
        } else {
            repeatSelect.disabled = false;
        }

        // Afficher les boutons d'édition et masquer le bouton d'ajout
        addEventButton.style.display = 'none';
        updateEventButton.style.display = 'inline-block';
        cancelEditButton.style.display = 'inline-block';

        // Faire défiler jusqu'au formulaire
        form.scrollIntoView({ behavior: 'smooth' });

        renderEvents();
    }

    function handleDeleteClick(e) {
        const index = parseInt(e.target.getAttribute('data-index'));
        if (confirm('Êtes-vous sûr de vouloir supprimer cet événement ?')) {
            events.splice(index, 1);
            renderEvents();

            if (editingIndex === index) {
                cancelEdit();
            } else if (editingIndex > index) {
                editingIndex--; // Ajuster l'index d'édition si l'élément supprimé était avant l'élément en cours d'édition
            }
        }
    }

    function cancelEdit() {
        editingIndex = -1;
        form.reset();

        // Réinitialiser l'interface
        addEventButton.style.display = 'inline-block';
        updateEventButton.style.display = 'none';
        cancelEditButton.style.display = 'none';
        repeatSelect.disabled = false;
        daysGroup.style.display = 'none';

        // Décocher toutes les cases de jours
        const dayCheckboxes = daysGroup.querySelectorAll('input[type="checkbox"]');
        dayCheckboxes.forEach(checkbox => checkbox.checked = false);

        renderEvents();
    }

    // Annuler l'édition
    cancelEditButton.addEventListener('click', cancelEdit);

    // Mettre à jour un événement
    updateEventButton.addEventListener('click', (e) => {
        e.preventDefault();

        if (editingIndex === -1) return;

        if (!validateForm()) return;

        const updatedEvent = createEventObject();
        events[editingIndex] = updatedEvent;

        cancelEdit();
        renderEvents();
    });

    // Fonctions existantes pour la gestion du formulaire
    repeatSelect.addEventListener('change', () => {
        daysGroup.style.display = repeatSelect.value === 'days' ? 'block' : 'none';
    });

    dateInput.addEventListener('input', handleDateChange);
    humidityInput.addEventListener('input', handleConditionChange);
    tempInput.addEventListener('input', handleConditionChange);
    lumiInput.addEventListener('input', handleConditionChange);
    hourInput.addEventListener('input', handleConditionChange);

    function handleDateChange() {
        if (dateInput.value) {
            // Si une date est sélectionnée, réinitialiser et désactiver l'option de répétition
            repeatSelect.value = 'never';
            repeatSelect.disabled = true;

            // Masquer le groupe de jours si visible
            daysGroup.style.display = 'none';

            // Décocher toutes les cases de jours
            const dayCheckboxes = daysGroup.querySelectorAll('input[type="checkbox"]');
            dayCheckboxes.forEach(checkbox => checkbox.checked = false);
        } else {
            // Si la date est effacée, réactiver l'option de répétition
            repeatSelect.disabled = false;
        }
    }

    function handleConditionChange() {
        // Activer/désactiver les contraintes selon les champs remplis
        const hasCondition = humidityInput.value || tempInput.value || lumiInput.value;

        // Si l'utilisateur a sélectionné une heure mais pas de date, permettre la répétition
        if (hourInput.value && !dateInput.value) {
            repeatSelect.disabled = false;
        }
    }

    resetButton.addEventListener('click', (e) => {
        e.preventDefault();
        form.reset();
        repeatSelect.disabled = false;
        daysGroup.style.display = 'none';

        // Décocher toutes les cases de jours
        const dayCheckboxes = daysGroup.querySelectorAll('input[type="checkbox"]');
        dayCheckboxes.forEach(checkbox => checkbox.checked = false);

        // Annuler l'édition si en cours
        if (editingIndex !== -1) {
            cancelEdit();
        }
    });

    // Fonction de validation du formulaire
    function validateForm() {
        const action = document.getElementById('action').value;
        const humidity = humidityInput.value;
        const temperature = tempInput.value;
        const luminosity = lumiInput.value;
        const date = dateInput.value;
        const hour = hourInput.value;

        if (!action) {
            alert("Veuillez sélectionner une action.");
            return false;
        }

        const hasCondition = humidity || temperature || luminosity;

        // Cas 1: Aucune condition environnementale, il faut une date ET une heure
        if (!hasCondition && (!date || !hour)) {
            alert("Vous devez spécifier à la fois une date ET une heure lorsque vous ne spécifiez pas de conditions (humidité, température ou luminosité).");
            return false;
        }

        return true;
    }

    // Fonction pour créer un objet événement à partir du formulaire
    function createEventObject() {
        const action = document.getElementById('action').value;
        const humidity = humidityInput.value;
        const temperature = tempInput.value;
        const luminosity = lumiInput.value;
        const date = dateInput.value;
        const hour = hourInput.value;

        // Déterminer la valeur de répétition
        let repeatValue = repeatSelect.value;
        if (repeatValue === 'days') {
            const checkedDays = Array.from(daysGroup.querySelectorAll('input:checked')).map(cb => cb.value);
            repeatValue = checkedDays.join('');
        }

        const event = {
            action: action,
            condition: {},
            repeat: repeatValue || "never"
        };

        if (humidity) event.condition.humidity = parseFloat(humidity);
        if (temperature) event.condition.temperature = parseFloat(temperature);
        if (luminosity) event.condition.luminosity = parseFloat(luminosity);

        if (date) {
            // Convertir la date de YYYY-MM-DD à DD/MM/YYYY
            const dateObj = new Date(date);
            const day = String(dateObj.getDate()).padStart(2, '0');
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const year = dateObj.getFullYear();
            event.condition.date = `${day}/${month}/${year}`;
        }

        if (hour) event.condition.hour = hour;

        return event;
    }

    // Gérer la soumission du formulaire pour ajouter un nouvel événement
    form.addEventListener('submit', (e) => {
        e.preventDefault();

        if (!validateForm()) return;

        const newEvent = createEventObject();
        events.push(newEvent);
        console.log(newEvent)
        var json = JSON.stringify(newEvent);
        monStockage.setItem("event", json);

        form.reset();
        daysGroup.style.display = 'none';
        repeatSelect.disabled = false;

        // Décocher toutes les cases de jours
        const dayCheckboxes = daysGroup.querySelectorAll('input[type="checkbox"]');
        dayCheckboxes.forEach(checkbox => checkbox.checked = false);

        renderEvents();
    });
</script>

</body>
</html>
